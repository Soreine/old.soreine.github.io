<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <!-- Meta information -->
    <title>Soreine - A Bot to Play the Cardinal Flash Game</title>     
    <link rel="icon" type="image/png" href="/images/logo-tiny.png">

    <!-- CSS -->
    <link rel="stylesheet" href="/css/style.css" />
    <!-- Google Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Quicksand:300' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Lato:400' rel='stylesheet' type='text/css'>
    
    <!-- OG attributes -->
    <meta name="Description" content="Personal page of Soreine, video games related things enthusiast.">
    <meta property="og:title" content="Soreine - A Bot to Play the Cardinal Flash Game" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="http://soreine.github.io/" />
    <meta property="og:image" content="http://soreine.github.io/images/og-image.png" />

  </head>
  <body class="prog">
    
    <div class="page">

      <!-- HEADER -->
      <header class="header section">
	<div class="container">
	  <a href="/">
	    <div id="logo">
	      <svg id="logo-image" xmlns="http://www.w3.org/2000/svg"
		   viewBox="0 0 100 60" version="1.1"> 
		<defs>
		  <linearGradient id="gradient" gradientUnits="userSpaceOnUse"
				  x1="0" x2="100" y1="0" y2="0">
		    <stop id="left-color" offset="0" stop-color="#000000"/>
		    <stop id="right-color" offset="1" stop-color="#000000"/> 
		  </linearGradient>
		</defs> 
		<path id="mask" d="m49.8 24.32c0-13.57 14.57-19.75 26.65-19.75 6.97 0 20.07-2.54 23.55-4.57v21.96c0 16.34-16.61 22.02-24.71 22.02-9.28 0-19.8 6.04-25.49 16.02 0.04-15.68 0-26.47 0-35.68zm35.89 12.07c2.68-4.14 4-8.04 3.03-12.91-1.15-5.45-5.03-9.84-10.22-11.57-1.76-0.61-2.76-0.71-4.8-0.71-6.55 0.51-11.87 3.93-14.23 9.61-1.6 4.54-1.42 8.82 0.4 12.69 1.44 2.84 3.68 5.13 6.24 6.64 4.37-5.1 16.35-4.59 19.56-3.71zm-71.18-0.06c-0.5-0.61-1.43-2.13-1.77-2.8-1.86-3.78-2.13-8.37-0.7-12.27 1.58-4.33 4.99-7.77 9.22-9.31 2.87-1.04 6.03-1.2 8.96-0.51 5.32 1.34 9.59 5.59 11.07 10.99 1.37 4.99 0.06 10.57-3.38 14.47-1.16 1.31-3.41 3.09-3.88 3.06-4.61-4.71-14.55-5.01-19.5-3.66zm-14.51-36.32c3.23 1.88 15.67 4.62 22.86 4.62-13.29 1.45-21.26 7.34-22.76 17.72-0.13-7.66-0.1-14.53-0.1-22.34z"
		      fill="url(#gradient)"/> 
	      </svg>
	      <br/>
	      Soreine
	    </div>
	  </a>
	  <nav>
            <ul>
	      <li><a href="/music/">â™ª Music</a></li>
	      <li><a href="/art/">Art</a></li>
	      <li class="active"><a href="/prog/">Prog</a></li>
	      <li><a href="/about/">About</a></li>
            </ul>
	  </nav>
	</div> <!-- container -->

	<div class="break">
	</div>
      </header> <!-- /header -->

      <!-- CONTENT -->
      <section>
	<div class="content">
	  <div class="container">

	    <!--DESCRIPTION-->
	    <div class="description">
              <h1>A Bot to Play the Cardinal Flash Game</h1>              
              <p>
                After reading this article on 
                <a href="http://inventwithpython.com/blog/2014/12/17/programming-a-bot-to-play-the-sushi-go-round-flash-game/">
                  Programming a Bot to Play the "Sushi Go Round" Flash
                  Game There</a>, I wanted to follow the example and
                make my own Flash game bot. I chose the Flash game 
                <a href="http://www.newgrounds.com/portal/view/634256">
                Cardinal</a> because its mechanics are simple: you are
                prompted with a direction to move (by pressing one of
                the directional keys), one after the other, until you
                fail because of the response time getting shorter. In
                fact you are a cube surrounded by four wall presses,
                and only one them is absent each time: your exit in
                other words. If you fail to escape in time, the walls
                crush you. My mere human skills escaped death 86 times
                in a row, whereas my bot was still alive after the
                10,000th round and beyond.
              </p>

              <a title="11K+ High Score" href="high-score.png">
                <figure>
                  <img alt="11K+ High Score" src="high-score.png"/>
                  <figcaption>11,229 High Score achieved with the 2nd
                  version of the bot.</figcaption>
                </figure>
              </a>

              <h2>First step - Making the bot play correctly</h2>
              <p>
                Here is the process the bot needs to follow to play the game correctly:
              </p>
              <ul>
                <li>Locate the game area on screen</li>
                <li>Click the Play button so the game starts</li>
                <li>Look for the missing wall in the current setup</li>
                <li>Press the corresponding direction and wait for the next round</li>
              </ul>
              <p>
                To this end, we can take screenshots, look for given
                images on the screen, move the cursor and input
                keys. These fundamentals actions are made available
                through the <a href="https://github.com/asweigart/pyautogui/">pyautogui</a> 
                module.
              </p>
              <p>
                Locating the game area on the screen is easy as long
                as there is a part of the game startup screen that is
                constant. We can just locate that sub-image on the whole
                screen and deduce from that the relative coordinates
                of the game screen and all the elements whose
                positions are fixed. We can then safely move the
                cursor to the Play button position and click.
              </p>

              <p>
                As the walls' positions are fixed, looking for the
                missing wall consist in taking a screenshot and
                checking the color value of one pixel from each wall's
                known position. If one of these pixels doesn't match
                the red color of a wall, then the corresponding way is
                clear. We can then make a move and input the
                appropriate direction!
              </p>

              <a title="Gameplay Screenshot" href="escaping.png">
                <figure>
                  <img alt="Gameplay Screenshot" src="escaping.png"/>
                  <figcaption>The square escaping through the right opening.</figcaption>
                </figure>
              </a>

              <p>
                After moving, we must wait until the animation of the
                escaping square is over and a new walls setup is
                displayed. The red square is always put back to the
                center of the screen before every move. So we can
                watch for that moment to come before continuing, by
                repeatedly taking screenshots and checking the
                presence of the square. However, <em>pyautogui is slow</em> at
                taking screenshots (>100ms). I suspect it is because
                it saves images in a temporary file. So if we don't
                want to be late for the next round, we must time our
                screenshot so it happens short after the square is
                back to the center. By timing the screenshot well, we
                can be just in time to make the next move. The whole
                performance of the bot lies on this precise
                timing.
              </p>

              <p>
                Unfortunately, a screenshot duration varies, so we can only
                assume it has an upper bound. Practically, this means
                that we must time it so the result is available some
                time after the next round, but still keep some room
                for error. In the worst case, we get a screenshot just
                <em>before</em> the next round and we have to retake a
                screenshot, which takes a lot of time, usually
                resulting in our time being up. The first version of
                the bot would not go higher than a 80 score.
              </p>

              <h2>Second step - Gotta go fast</h2>

              <p>
                In order to improve the bot's performance, we must
                make faster screenshots. I chose a simple way to
                achieve that. Instead of using the built-in screenshot
                feature of pyautogui, I would create a small C API for
                taking screenshot, using the <a href="http://en.wikipedia.org/wiki/Xlib">Xlib</a>
                library and use this API in Python with the 
                <a href="https://docs.python.org/3.4/library/ctypes.html">ctypes</a>
                module. The C code just need to be compiled as a
                shared library to be loaded by Python. The C code does
                not save pictures in temporary files but store them in
                memory as XImage structures. The only downside is that
                you now have to handle memory management in Python
                too. But now we can also take screenshots of the game
                region in about 12ms, which is inferior to a frame
                duration! That means enough speed to actually watch
                repeatedly for the next round to come, as we wanted to
                do in the first place.
              </p>

              <p>
                While the reaction time window shrinks as the game
                progresses, it seems it will not fall under the
                duration of a frame. This means in practice that this
                second version of the bot is able to play the game
                indefinetely. I left it run for two hours one day, and
                it was still playing past the 10,000 score mark. I had
                to kill it, sadly, as its power was becoming a threat
                for mankind. It also took away all the fun from this
                game in the process&hellip;
              </p>

              <p>
                Now I need to find a new game &mdash;sigh&mdash;.
              </p>

              <a href="https://github.com/Soreine/cardinal-bot/">
                <img alt="GitHub" 
                     style="vertical-align:middle"
                     src="/images/GitHub-Mark.svg"/>
                See on GitHub
              </a>
	    </div>
	    <!-- /.description -->
            
	  </div> <!-- /container -->	  
	</div> <!-- /content -->
      </section>
      
    </div> <!-- /page -->

    <!-- FOOTER -->
    <footer class="footer">
      
      <div class="container">
	<div class="contact">
	  <p class="contact">Contact&nbsp;: <a href="mailto:soreine.plume@gmail.com">&lt;soreine.plume&#64;gmail.com&gt;</a></p>
	</div> <!-- contact -->
	<div class="copyright">
          <p>Except as otherwise noted, the content of this page is
            licensed under a <a rel="license"
				href="http://creativecommons.org/licenses/by/4.0/">Creative
              Commons Attribution 4.0 International
              License</a> <a rel="license"
			     href="http://creativecommons.org/licenses/by/4.0/">
          </a></p>
	  <a rel="license"
	     href="http://creativecommons.org/licenses/by/4.0/">
	    <img alt="Creative Commons License" style="border-width:0"
		 src="/images/cc-by.svg"/>
          </a>
	</div> <!-- copyright -->
      </div> <!-- /container -->
    </footer>
  </body>
</html>
